<ui:composition xmlns="http://www.w3.org/1999/xhtml" xmlns:f="http://java.sun.com/jsf/core"
	xmlns:p="http://primefaces.prime.com.tr/ui" xmlns:h="http://java.sun.com/jsf/html"
	xmlns:ui="http://java.sun.com/jsf/facelets" xmlns:m="http://www.ol4jsf.org"
	template="/template/main.xhtml">

	<ui:define name="header">
	<script src='http://maps.google.com/maps?file=api&amp;v=2&amp;key=ABQIAAAAjpkAC9ePGem0lIq5XcMiuhR_wWLPFku8Ix9i2SXYRVK3e45q1BQUd_beF8dtzKET_EteAjPdGDwqpQ'></script>
	</ui:define>

	<ui:define name="body">
		<h:form>
			<p:toolbar>
				<p:toolbarGroup align="left">
					<p:commandButton title="#{messages['button.new']}" image="ui-icon-document" action="#{contactListMB.getNextView}"
						actionListener="#{contactListMB.clear}" ajax="false" />

					<p:commandButton title="#{messages['button.delete']}" image="ui-icon-trash" onclick="confirmation.show()"
						type="button" immediate="true" ajax="false" />

					<p:confirmDialog message="#{messages['label.confirm.delete']}" showEffect="bounce" hideEffect="explode"
						header="#{messages['label.dialog.alert']}!" severity="alert" widgetVar="confirmation">

						<h:commandButton value="#{messages['button.dialog.yes']}" action="#{contactListMB.deleteSelection}"
							actionListener="#{contactListMB.clear}" />
						<h:commandButton value="#{messages['button.dialog.no']}" onclick="confirmation.hide()" type="button" />
					</p:confirmDialog>
				</p:toolbarGroup>
				<p:toolbarGroup align="right">
				<p:commandButton title="#{messages['button.kml']}" image="icon-kml" ajax="false" >
					<p:fileDownload value="#{contactListMB.kml}" />
				</p:commandButton>
				<p:commandButton title="#{messages['button.shapefile']}" image="icon-shapefile" ajax="false" >
					<p:fileDownload value="#{contactListMB.shapefile}" />
				</p:commandButton>
				</p:toolbarGroup>
			</p:toolbar>
	
			<p:dataTable id="list" var="bean" value="#{contactListMB.resultList}">
				<f:facet name="header">#{messages['contact.list.table.title']}</f:facet>
				<p:column style="width:5%;">
					<h:selectBooleanCheckbox value="#{contactListMB.selection[bean.id]}"></h:selectBooleanCheckbox>
				</p:column>
				<p:column style="width:5%;" sortBy="#{bean.id}">
					<f:facet name="header">#{messages['contact.label.id']}</f:facet>
					<h:outputText value="#{bean.id}" />
				</p:column>
				<p:column sortBy="#{bean.name}">
					<f:facet name="header">#{messages['contact.label.name']}</f:facet>
					<h:commandLink action="#{contactListMB.getNextView}" actionListener="#{contactListMB.clear}">
						<h:outputText value="#{bean.name}" />
						<f:param name="id" value="#{bean.id}" />
					</h:commandLink>
				</p:column>
				<p:column sortBy="#{bean.telephone}">
					<f:facet name="header">#{messages['contact.label.telefone']}</f:facet>
					<h:commandLink action="#{contactListMB.getNextView}" actionListener="#{contactListMB.clear}">
						<h:outputText value="#{bean.telephone}" />
						<f:param name="id" value="#{bean.id}"/>
					</h:commandLink>
				</p:column>
				<p:column sortBy="#{bean.address}">
					<f:facet name="header">Endereco</f:facet>
					<h:commandLink action="#{contactListMB.getNextView}" actionListener="#{contactListMB.clear}">
						<h:outputText value="#{bean.address}" />
						<f:param name="id" value="#{bean.id}"/>
					</h:commandLink>
				</p:column>
					<p:column style="width:5%;">
					<p:commandButton value="Map" onclick="map.setCenter(new OpenLayers.LonLat(#{bean.point.centroid.x}, #{bean.point.centroid.y}), map.getZoom());" type="button"/>
				</p:column>
			</p:dataTable>
			<div id="box_mapa">
			<div id="toolbar" >
			<div id="toolbar_group"></div>
			</div>
			<script type="text/javascript">
			var map2,selectControl2,layer_vector2,selectedFeature;

			function onPopupClose(evt) {
			    selectControl2.unselect(selectedFeature);
			}
			
			function onFeatureSelect(feature) {
				
				selectedFeature = feature;
			    popup = new OpenLayers.Popup.FramedCloud("popup", 
			                             feature.geometry.getBounds().getCenterLonLat(),
			                             null,
			                             '<div>' + feature.data.name + '<br/>' + feature.data.address + '</div>',
			                             null, true, onPopupClose);
			    feature.popup = popup;
			    map2.addPopup(popup);

			}

			function onFeatureUnselect(feature) {
			    map2.removePopup(feature.popup);
			    feature.popup.destroy();
			    feature.popup = null;
			}

			function createEvents(layer_vector,map){
				map2 = map;
				layer_vector2 = layer_vector;
				selectControl = new OpenLayers.Control.SelectFeature(layer_vector, {onSelect: onFeatureSelect, onUnselect: onFeatureUnselect});
				map.addControl(selectControl);
	            selectControl.activate();

	            selectControl2 = selectControl;
			}
			
			

			</script>
			<m:map id="map" width="1000" height="400" jsVariable="map" 
				options="{
					controls: [],
					numZoomLevels: 18,
					units: 'm',
					maxResolution: 156543.0339,
                    maxExtent: new OpenLayers.Bounds(
                       1549471.9221, 6403610.94, 1550001.32545, 6404015.8
                       ),
					projection: new OpenLayers.Projection('EPSG:900913'),
        			displayProjection: new OpenLayers.Projection('EPSG:4326')
					}">	
					<m:osmLayer/>
					<m:googleLayer name="Google Physical" options="{type: G_PHYSICAL_MAP}"/>
                    <m:googleLayer name="Google Streets" options="{numZoomLevels: 20}"/>
                    <m:googleLayer name="Google Hybrid" options="{type: G_HYBRID_MAP, numZoomLevels: 20}"/>
                    <m:googleLayer name="Google Satellite" options="{type: G_SATELLITE_MAP, numZoomLevels: 20}"/>
	             	<m:layerSwitcherControl />
	              	<m:navigationControl />
	                <m:panZoomBarControl />
	                <m:layerSwitcherControl options="{ascending:false}"/>
	                <m:scaleLineControl />
	                <m:mousePositionControl />
	                <m:overviewMapControl />
	                <m:keyboardDefaultsControl />
	                <m:permalinkControl />	                
					<m:vectorLayer name="Contacts" value="#{contactListMB.resultFeatureList}" jsVariable="features"/>
					<m:vectorLayer name="Contects JSON" jsVariable="json_vector"
                                   options="{
                                   strategies: [new OpenLayers.Strategy.Fixed()],
                                   protocol: new OpenLayers.Protocol.HTTP({
                                   url: 'georest/contact/list?SRID=900913',
                                   format: new OpenLayers.Format.GeoJSON()
                                   })
                                   }"/>
					<m:panelControl options="{div:document.getElementById('toolbar_group')}" jsVariable="toolbar">
						<m:zoomToMaxExtentControl options="{title:'Reset Zoom Map'}"/>
					</m:panelControl>
					<m:script>toolbar.addControls(new OpenLayers.Control.MouseDefaults({title:'Pan'}));</m:script>
					<m:script>toolbar.addControls(new OpenLayers.Control.ZoomBox({alwaysZoom:true, title:'Zoom box'}));</m:script>
					<m:script>toolbar.addControls(new OpenLayers.Control.ZoomIn({title:'Zoom in'}));</m:script>   
					<m:script>toolbar.addControls(new OpenLayers.Control.ZoomOut({title:'Zoom out'}));</m:script>
					<m:script>createEvents(json_vector,map)</m:script>
					<m:script>map.setCenter(new OpenLayers.LonLat(10.2, 48.9), 5);</m:script>
					<m:script>map.zoomToExtent(features.getDataExtent());</m:script>
         		</m:map>
         		</div>
         		<script type="text/javascript">
         		
         		//for (var i in map_ol.layers[2].features){ alert(map_ol.layers[2].features[i]);}
         			//alert(map_ol.layers);	
         		</script>
         		
			
		</h:form>
	</ui:define>
</ui:composition>